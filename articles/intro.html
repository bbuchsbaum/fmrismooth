<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Getting Started with fmrismooth • fmrismooth</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started with fmrismooth">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fmrismooth</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/bilateral-lattice.html">Joint Bilateral Smoothing with a Permutohedral Lattice</a></li>
    <li><a class="dropdown-item" href="../articles/guided-filter.html">Edge-Preserving Guided Filtering (3D/4D)</a></li>
    <li><a class="dropdown-item" href="../articles/intro.html">Getting Started with fmrismooth</a></li>
    <li><a class="dropdown-item" href="../articles/mppca.html">MP–PCA Denoising for fMRI</a></li>
    <li><a class="dropdown-item" href="../articles/robust-tv.html">Robust TV: Huber and Tukey Data Terms</a></li>
    <li><a class="dropdown-item" href="../articles/tv-denoising.html">Space–Time Total Variation Denoising</a></li>
    <li><a class="dropdown-item" href="../articles/vst.html">Variance–Stabilizing Transform (VST) for Rician Magnitude</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Getting Started with fmrismooth</h1>
                        <h4 data-toc-skip class="author">fmrismooth
authors</h4>
            
            <h4 data-toc-skip class="date">2025-08-28</h4>
      

      <div class="d-none name"><code>intro.Rmd</code></div>
    </div>

    
    
<p>The goal of fmrismooth is to make practical, edge‑preserving
smoothing and denoising easy to apply to fMRI volumes and time series.
The package brings together fast lattice bilateral filters, robust and
TV‑based denoisers, MP‑PCA, and simple VST wrappers, with functions that
accept plain numeric arrays and optionally integrate with
<code>neuroim2</code> if you work with
<code>NeuroVol</code>/<code>NeuroVec</code> objects. The examples below
use small synthetic arrays to keep the vignette self‑contained and fast
to run.</p>
<div class="section level2">
<h2 id="quick-start-oneliner-pipeline">Quick start: one‑liner pipeline<a class="anchor" aria-label="anchor" href="#quick-start-oneliner-pipeline"></a>
</h2>
<p>The most convenient entry point is <code><a href="../reference/fmrismooth_default.html">fmrismooth_default()</a></code>,
which infers reasonable parameters from the data and optionally runs a
robust stage before a joint bilateral final stage.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrismooth/">fmrismooth</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span>, <span class="fl">8</span>, <span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">100</span>, dim <span class="op">=</span> <span class="va">dims</span><span class="op">)</span></span>
<span><span class="va">noisy</span> <span class="op">&lt;-</span> <span class="va">clean</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="va">dims</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, dim <span class="op">=</span> <span class="va">dims</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># One-liner with auto-parameters and joint bilateral final stage</span></span>
<span><span class="va">smoothed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_auto.html">smooth_auto</a></span><span class="op">(</span><span class="va">noisy</span>, robust <span class="op">=</span> <span class="st">"none"</span>, auto_params <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>var_original <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">noisy</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  var_smoothed  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">smoothed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; var_original var_smoothed </span></span>
<span><span class="co">#&gt;     16.64967     13.54920</span></span></code></pre></div>
<p>The default pipeline estimates spatial/temporal bandwidths and noise
scale from the data, then applies design‑aware joint bilateral smoothing
across space and time. If you have a T1 or probability maps, pass them
as guides; otherwise the spatial mean of the current estimate serves as
a weak guide.</p>
</div>
<div class="section level2">
<h2 id="mppca-joint-bilateral">MP‑PCA + joint bilateral<a class="anchor" aria-label="anchor" href="#mppca-joint-bilateral"></a>
</h2>
<p>For stronger denoising while preserving structure, combine MP‑PCA
with joint bilateral filtering using
<code><a href="../reference/fmrismooth_mppca_pipeline.html">fmrismooth_mppca_pipeline()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mp_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_mppca.html">smooth_mppca</a></span><span class="op">(</span></span>
<span>  <span class="va">noisy</span>,</span>
<span>  sigma_mode <span class="op">=</span> <span class="st">"global"</span>,   <span class="co"># estimate one sigma from temporal differences</span></span>
<span>  sigma_sp   <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>  sigma_t    <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  sigma_r    <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  lattice_blur_iters <span class="op">=</span> <span class="fl">1L</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>var_original <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">noisy</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  var_mppca    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">mp_out</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; var_original    var_mppca </span></span>
<span><span class="co">#&gt; 16.649674935  0.007190354</span></span></code></pre></div>
<p>This pipeline first denoises overlapping space×time patches with PCA,
then smooths with a weakly temporal‑aware lattice bilateral filter.
Where patches do not contribute (e.g., outside the mask), the original
signal is preserved.</p>
</div>
<div class="section level2">
<h2 id="joint-bilateral-filtering-directly">Joint bilateral filtering directly<a class="anchor" aria-label="anchor" href="#joint-bilateral-filtering-directly"></a>
</h2>
<p>If you want more direct control over bandwidths and guides, call
<code><a href="../reference/fast_bilateral_lattice4d.html">fast_bilateral_lattice4d()</a></code> or its 3D counterpart.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 4D joint bilateral with explicit parameters</span></span>
<span><span class="va">jb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bilat_lattice4d.html">bilat_lattice4d</a></span><span class="op">(</span></span>
<span>  <span class="va">noisy</span>,</span>
<span>  sigma_sp <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>  sigma_t  <span class="op">=</span> <span class="fl">0.6</span>,</span>
<span>  sigma_r  <span class="op">=</span> <span class="fl">10.0</span>,</span>
<span>  guide_spatial <span class="op">=</span> <span class="cn">NULL</span>,   <span class="co"># optional 3D guide; omit for self-guided</span></span>
<span>  guides <span class="op">=</span> <span class="cn">NULL</span>,          <span class="co"># optional list of 3D guides (e.g., tissue probs)</span></span>
<span>  design <span class="op">=</span> <span class="cn">NULL</span>,          <span class="co"># optional length-T regressor for design-aware feature</span></span>
<span>  mask <span class="op">=</span> <span class="cn">NULL</span>             <span class="co"># optional 3D mask</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">jb</span><span class="op">)</span>, <span class="va">dims</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Under the hood, features are embedded in a permutohedral lattice;
values are splatted to lattice vertices, blurred along simplex axes, and
sliced back to the image grid. The range bandwidth <code>sigma_r</code>
can be a vector when using multiple guides.</p>
</div>
<div class="section level2">
<h2 id="robust-and-tvbased-smoothing">Robust and TV‑based smoothing<a class="anchor" aria-label="anchor" href="#robust-and-tvbased-smoothing"></a>
</h2>
<p>When the goal is artifact suppression with minimal blurring, total
variation methods and robust losses are often a good fit. The package
exposes a straightforward TV denoiser and a robust variant.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Space-time TV denoising (Chambolle-Pock)</span></span>
<span><span class="va">tv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tv_denoise4d.html">tv_denoise4d</a></span><span class="op">(</span><span class="va">noisy</span>, lambda_s <span class="op">=</span> <span class="fl">0.6</span>, lambda_t <span class="op">=</span> <span class="fl">0.2</span>, iters <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Robust variant using Huber or Tukey data terms</span></span>
<span><span class="va">rob</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tv_robust4d.html">tv_robust4d</a></span><span class="op">(</span><span class="va">noisy</span>, loss <span class="op">=</span> <span class="st">"huber"</span>, iters <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>var_tv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">tv</span><span class="op">)</span><span class="op">)</span>, var_rob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">rob</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    var_tv   var_rob </span></span>
<span><span class="co">#&gt;  5.274001 17.304458</span></span></code></pre></div>
<p>The spatial and temporal TV weights (<code>lambda_s</code>,
<code>lambda_t</code>) trade off fidelity and smoothness; the robust
version internally sets thresholds from an estimated noise scale if not
provided.</p>
</div>
<div class="section level2">
<h2 id="variancestabilizing-transform-wrapper">Variance‑stabilizing transform wrapper<a class="anchor" aria-label="anchor" href="#variancestabilizing-transform-wrapper"></a>
</h2>
<p>Magnitude MR data is Rician‑distributed. A simple yet effective
tactic is to apply a variance‑stabilizing transform (VST), denoise under
an approximate Gaussian model, then invert the transform. The
<code><a href="../reference/vst_wrap.html">vst_wrap()</a></code> helper encapsulates this pattern.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vst_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vst_denoise.html">vst_denoise</a></span><span class="op">(</span></span>
<span>  <span class="va">noisy</span>,</span>
<span>  denoise_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="fu"><a href="../reference/bilat_lattice4d.html">bilat_lattice4d</a></span><span class="op">(</span><span class="va">z</span>, sigma_sp <span class="op">=</span> <span class="fl">2.0</span>, sigma_t <span class="op">=</span> <span class="fl">0.4</span>, sigma_r <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>var_vst <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">vst_out</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  var_vst </span></span>
<span><span class="co">#&gt; 0.186229</span></span></code></pre></div>
<p>If <code>sigma</code> is not supplied and the input is 4D, the
wrapper estimates it from temporal differences in masked voxels.</p>
</div>
<div class="section level2">
<h2 id="choosing-parameters">Choosing parameters<a class="anchor" aria-label="anchor" href="#choosing-parameters"></a>
</h2>
<p>Sensible defaults are helpful, but you might want parameters tied to
voxel size and TR. The <code><a href="../reference/recommend_params.html">recommend_params()</a></code> helper looks at
spacing (when available), TR, and a global noise estimate, returning a
compact list you can pass into pipelines.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/suggest_params.html">suggest_params</a></span><span class="op">(</span><span class="va">noisy</span>, tr <span class="op">=</span> <span class="fl">2.0</span>, target_fwhm_mm <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">rec</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 5</span></span>
<span><span class="co">#&gt;  $ lambda_s: num 1.2</span></span>
<span><span class="co">#&gt;  $ lambda_t: num 0.159</span></span>
<span><span class="co">#&gt;  $ sigma_sp: num 1</span></span>
<span><span class="co">#&gt;  $ sigma_t : num 0.5</span></span>
<span><span class="co">#&gt;  $ sigma_r : num 5</span></span>
<span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_auto.html">smooth_auto</a></span><span class="op">(</span><span class="va">noisy</span>, robust <span class="op">=</span> <span class="st">"none"</span>, auto_params <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>In practice, start with the default pipeline, check the variance
reduction and the appearance of edges in a few slices, then refine with
joint bilateral or TV methods if you need more control. All functions
accept plain arrays; if you work with <code>neuroim2</code>, spatial
alignment happens automatically when both the fMRI object and guides
carry space metadata.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Your Name.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
